<!DOCTYPE html>
<html lang="es">
<head>
	<title>E-commerce - Finalizar Compra</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Outfit:400,500,600,700,800,900&amp;subset=latin" />
	<link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
	<link rel="icon" type="image/png" sizes="48x48" href="./favicon.png" />
</head>

<body>
	<!-- Navbar -->
	<nav class="navbar navbar-dark navbar-expand-lg bg-white py-5 py-lg-1 container">
		<div class="container-fluid">
			<a class="navbar-brand w-25" href="index.html">
				<img class="img-fluid w-25" src="./images/logo.png" alt="Logo E-commerce" />
			</a>
			<div class="d-lg-none">
				<a class="btn navbar-burger p-0" href="#">
					<svg width="35" height="35" viewbox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect class="text-light-light" width="32" height="32" rx="6" fill="currentColor"></rect><path class="text-secondary" d="M7 12H25C25.2652 12 25.5196 11.8946 25.7071 11.7071C25.8946 11.5196 26 11.2652 26 11C26 10.7348 25.8946 10.4804 25.7071 10.2929C25.5196 10.1054 25.2652 10 25 10H7C6.73478 10 6.48043 10.1054 6.29289 10.2929C6.10536 10.4804 6 10.7348 6 11C6 11.2652 6.10536 11.5196 6.29289 11.7071C6.48043 11.8946 6.73478 12 7 12ZM25 15H7C6.73478 15 6.48043 15.1054 6.29289 15.2929C6.10536 15.4804 6 15.7348 6 16C6 16.2652 6.10536 16.5196 6.29289 16.7071C6.48043 16.8946 6.73478 17 7 17H25C25.2652 17 25.5196 16.8946 25.7071 16.7071C25.8946 16.5196 26 16.2652 26 16C26 15.7348 25.8946 15.4804 25.7071 15.2929C25.5196 15.1054 25.2652 15 25 15ZM25 20H7C6.73478 20 6.48043 20.1054 6.29289 20.2929C6.10536 20.4804 6 20.7348 6 21C6 21.2652 6.10536 21.5196 6.29289 21.7071C6.48043 21.8946 6.73478 22 7 22H25C25.2652 22 25.5196 21.8946 25.7071 21.7071C25.8946 21.5196 26 21.2652 26 21C26 20.7348 25.8946 20.4804 25.7071 20.2929C25.5196 20.1054 25.2652 20 25 20Z" fill="currentColor"></path></svg>
				</a>
			</div>
		</div>
	</nav>

	<section class="overflow-hidden">
		<div class="d-none navbar-menu position-fixed top-0 end-0 bottom-0 w-75 mw-xs" style="z-index: 9999;">
			<div class="navbar-backdrop position-fixed top-0 start-0 end-0 bottom-0 bg-dark" style="opacity: 75%;"></div>
			<nav class="position-relative h-100 w-100 d-flex flex-column p-6 bg-white overflow-auto">
				<div class="d-flex align-items-center mb-5">
					<a class="me-auto h4 mb-0 text-decoration-none" href="#">
						<img class="img-fluid w-25" src="images/logo.png" alt="" />
					</a>
					<a class="navbar-close text-secondary" href="#">
						<svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
						</svg>
					</a>
				</div>
				<div id="navbar-burger-buttons" class="row align-items-center g-6">
					<!-- Los botones del menú burguer se insertarán aquí -->
				</div>
			</nav>
		</div>
	</section>

	<!-- Sección Principal -->
	<section class="py-5">
		<div class="container">
			<div class="mb-5">
				<h2 class="font-heading fs-7">Finalizar Compra</h2>
			</div>
			<div class="row g-5">
				<!-- Columna Resumen del Pedido -->
				<div class="col-lg-7">
					<div class="card shadow-sm">
						<div class="card-body p-4">
							<h4 class="card-title mb-4">Resumen del Pedido</h4>
							<div id="order-summary-container">
								<p class="text-muted">Cargando resumen...</p>
							</div>
							<hr>
							<div id="order-total-container" class="text-end">
								<!-- El total se cargará aquí -->
							</div>
						</div>
					</div>
				</div>

				<!-- Columna Dirección y Pago -->
				<div class="col-lg-5">
					<div class="card shadow-sm mb-4">
						<div class="card-body p-4">
							<h4 class="card-title mb-4">Dirección de Envío</h4>
							<div id="address-container">
								<p class="text-muted">Cargando direcciones...</p>
							</div>
							<!-- Formulario para nueva dirección -->
							<div id="new-address-form" class="mt-3" style="display: none;">
								<h5 class="mb-3">Añadir Nueva Dirección</h5>
								<div class="mb-2">
									<input type="text" id="new-address-street" class="form-control" placeholder="Calle y número">
								</div>
								<div class="mb-2">
									<input type="text" id="new-address-city" class="form-control" placeholder="Ciudad">
								</div>
								<div class="mb-2">
									<input type="text" id="new-address-zip" class="form-control" placeholder="Código Postal">
								</div>
								<button class="btn btn-sm btn-secondary" onclick="saveNewAddress()">Guardar Dirección</button>
								<button class="btn btn-sm btn-link" onclick="toggleNewAddressForm(false)">Cancelar</button>
							</div>
						</div>
					</div>

					<div class="card shadow-sm">
						<div class="card-body p-4">
							<h4 class="card-title mb-4">Método de Pago</h4>
							<div id="payment-method-container">
								<p class="text-muted">Cargando métodos de pago...</p>
							</div>
						</div>
					</div>

					<div class="d-grid mt-4">
						<button id="pay-button" class="btn btn-lg btn-success" onclick="processPayment()" disabled>Pagar</button>
					</div>
				</div>
			</div>
		</div>
	</section>

	<script src="js/burguer-button.js"></script>
	<script>
		const accessToken = localStorage.getItem('accessToken');

		document.addEventListener('DOMContentLoaded', function () {
			if (!accessToken) {
				window.location.href = 'login.html';
				return;
			}
			updateBurgerMenu();
			fetchCartDetails();
			fetchAddresses();
			fetchPaymentMethods();
		});

		function updateBurgerMenu() {
			const navbarBurgerButtons = document.getElementById('navbar-burger-buttons');
			const accessToken = localStorage.getItem('accessToken');
			
			if (accessToken) {
				// Usuario logueado
				navbarBurgerButtons.innerHTML = `
					<div class="col-12">
						<a class="link-secondary fs-11 fw-medium d-block w-100 text-center" href="mi_perfil.html">Mi Perfil</a>
					</div>
					<div class="col-12"> 
						<a class="link-secondary fs-11 fw-medium d-block w-100 text-center" href="index.html">Carrito</a>
					</div>
					<div class="col-12">
						<button class="btn btn-sm btn-danger shadow d-block w-100" onclick="logout()">Cerrar Sesión</button>
					</div>
				`;
			} else {
				// Usuario no logueado
				navbarBurgerButtons.innerHTML = `
					<div class="col-12">
						<a class="link-secondary fs-11 fw-medium d-block w-100 text-center" href="login.html">Iniciar Sesión</a>
					</div>
				`;
			}
		}

		function logout() {
			localStorage.removeItem('accessToken');
			window.location.href = 'index.html'; 
		}

		async function fetchApi(url, options = {}) {
			const defaultOptions = {
				headers: {
					'Content-Type': 'application/json',
					'Authorization': 'Bearer ' + accessToken
				}
			};
			const response = await fetch(url, { ...defaultOptions, ...options });
			if (!response.ok) {
				const errorData = await response.json().catch(() => ({ detail: 'Error desconocido' }));
				throw new Error(errorData.detail);
			}
			if (response.status === 204) return null;
			return response.json();
		}

		async function fetchCartDetails() {
			try {
				const cartDetails = await fetchApi('/carrito/mi_carrito/detalles');
				renderOrderSummary(cartDetails);
			} catch (error) {
				document.getElementById('order-summary-container').innerHTML = `<p class="text-danger">${error.message}</p>`;
			}
		}

		function renderOrderSummary(cartDetails) {
			const summaryContainer = document.getElementById('order-summary-container');
			const totalContainer = document.getElementById('order-total-container');
			summaryContainer.innerHTML = '';
			let total = 0;

			if (!cartDetails || cartDetails.length === 0) {
				summaryContainer.innerHTML = '<p class="text-muted">Tu carrito está vacío. Vuelve al inicio para añadir productos.</p>';
				document.getElementById('pay-button').disabled = true;
				return;
			}

			cartDetails.forEach(item => {
				summaryContainer.innerHTML += `
					<div class="d-flex justify-content-between align-items-center mb-2">
						<div>
							<p class="mb-0">${item.product_name} <small class="text-muted">x ${item.quantity}</small></p>
						</div>
						<span>$${(item.price * item.quantity).toFixed(2)}</span>
					</div>`;
				total += item.price * item.quantity;
			});

			totalContainer.innerHTML = `<h4 class="fw-bold">Total: $${total.toFixed(2)}</h4>`;
		}

		async function fetchAddresses() {
			try {
				// NOTA: Debes crear este endpoint en tu backend.
				const addresses = await fetchApi('/usuarios/me/direcciones');
				renderAddresses(addresses);
			} catch (error) {
				document.getElementById('address-container').innerHTML = `<p class="text-danger">No se pudieron cargar las direcciones. <a href="#" onclick="toggleNewAddressForm(true)">Añadir una nueva</a></p>`;
			}
		}

		function renderAddresses(addresses) {
			const container = document.getElementById('address-container');
			container.innerHTML = '';
			if (addresses.length > 0) {
				addresses.forEach(addr => {
					container.innerHTML += `
						<div class="form-check">
							<input class="form-check-input" type="radio" name="address" id="addr-${addr.id}" value="${addr.id}" onchange="checkFormValidity()">
							<label class="form-check-label" for="addr-${addr.id}">
								${addr.address}, ${addr.city}, ${addr.zip_code}
							</label>
						</div>`;
				});
			}
			container.innerHTML += `<a href="#" class="d-block mt-2" onclick="toggleNewAddressForm(true)">+ Añadir nueva dirección</a>`;
			checkFormValidity();
		}

		function toggleNewAddressForm(show) {
			document.getElementById('new-address-form').style.display = show ? 'block' : 'none';
		}

		async function saveNewAddress() {
			const address = document.getElementById('new-address-street').value;
			const city = document.getElementById('new-address-city').value;
			const zip_code = document.getElementById('new-address-zip').value;

			if (!address || !city || !zip_code) {
				alert('Por favor, completa todos los campos de la dirección.');
				return;
			}

			try {
				// NOTA: Debes crear este endpoint en tu backend.
				await fetchApi('/usuarios/me/direcciones', {
					method: 'POST',
					body: JSON.stringify({ address, city, zip_code })
				});
				toggleNewAddressForm(false);
				fetchAddresses(); // Recargar la lista de direcciones
			} catch (error) {
				alert('Error al guardar la dirección: ' + error.message);
			}
		}

		async function fetchPaymentMethods() {
			try {
				// NOTA: Debes crear este endpoint en tu backend.
				const methods = await fetchApi('/metodos_pago/');
				renderPaymentMethods(methods);
			} catch (error) {
				document.getElementById('payment-method-container').innerHTML = `<p class="text-danger">No se pudieron cargar los métodos de pago.</p>`;
			}
		}

		function renderPaymentMethods(methods) {
			const container = document.getElementById('payment-method-container');
			container.innerHTML = '';
			methods.forEach(method => {
				container.innerHTML += `
					<div class="form-check">
						<input class="form-check-input" type="radio" name="payment" id="payment-${method.id}" value="${method.id}" onchange="checkFormValidity()">
						<label class="form-check-label" for="payment-${method.id}">
							${method.name}
						</label>
					</div>`;
			});
			checkFormValidity();
		}

		function checkFormValidity() {
			const selectedAddress = document.querySelector('input[name="address"]:checked');
			const selectedPayment = document.querySelector('input[name="payment"]:checked');
			document.getElementById('pay-button').disabled = !(selectedAddress && selectedPayment);
		}

		async function processPayment() {
			const address_id = document.querySelector('input[name="address"]:checked').value;
			const payment_method_id = document.querySelector('input[name="payment"]:checked').value;

			document.getElementById('pay-button').disabled = true;
			document.getElementById('pay-button').innerText = 'Procesando...';

			try {
				const result = await fetchApi('/carrito/mi_carrito/finalizar_compra', {
					method: 'POST',
					body: JSON.stringify({ address_id: parseInt(address_id), payment_method_id: parseInt(payment_method_id) })
				});
				alert(`${result.message} Tu número de pedido es: ${result.order_id}`);
				window.location.href = 'index.html';
			} catch (error) {
				alert('Error al procesar el pago: ' + error.message);
				document.getElementById('pay-button').disabled = false;
				document.getElementById('pay-button').innerText = 'Pagar';
			}
		}
	</script>
</body>
</html>