<!DOCTYPE html>
<html lang="es">
<head>
	<title>E-commerce - Finalizar Compra</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Outfit:400,500,600,700,800,900&amp;subset=latin" />
	<link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
	<link rel="stylesheet" href="css/styles.css">
	<link rel="icon" type="image/png" sizes="48x48" href="./favicon.png" />
</head>

<body>
	<!-- Placeholder para el header reutilizable -->
    <div id="header-placeholder"></div>

	<!-- Sección Principal -->
	<section class="py-5">
		<div class="container">
			<div class="mb-5">
				<h2 class="font-heading fs-7">Finalizar Compra</h2>
			</div>
			<div class="row g-5">
				<!-- Columna Resumen del Pedido -->
				<div class="col-lg-7">
					<div class="card shadow-sm">
						<div class="card-body p-4">
							<h4 class="card-title mb-4">Resumen del Pedido</h4>
							<div id="order-summary-container">
								<p class="text-muted">Cargando resumen...</p>
							</div>
							<hr>
							<div id="order-total-container" class="text-end">
								<!-- El total se cargará aquí -->
							</div>
						</div>
					</div>
				</div>

				<!-- Columna Dirección y Pago -->
				<div class="col-lg-5">
					<div class="card shadow-sm mb-4">
						<div class="card-body p-4">
							<h4 class="card-title mb-4">Dirección de Envío</h4>
							<div id="address-container">
								<p class="text-muted">Cargando direcciones...</p>
							</div>
							<!-- Formulario para nueva dirección -->
							<div id="new-address-form" class="mt-3" style="display: none;">
								<h5 class="mb-3">Añadir Nueva Dirección</h5>
								<div class="mb-2">
									<input type="text" id="new-address-street" class="form-control" placeholder="Calle y número">
								</div>
								<div class="mb-2">
									<input type="text" id="new-address-city" class="form-control" placeholder="Ciudad">
								</div>
								<div class="mb-2">
									<input type="text" id="new-address-zip" class="form-control" placeholder="Código Postal">
								</div>
								<button class="btn btn-sm btn-secondary" onclick="saveNewAddress()">Guardar Dirección</button>
								<button class="btn btn-sm btn-link" onclick="toggleNewAddressForm(false)">Cancelar</button>
							</div>
						</div>
					</div>

					<div class="card shadow-sm">
						<div class="card-body p-4">
							<h4 class="card-title mb-4">Método de Pago</h4>
							<div id="payment-method-container">
								<p class="text-muted">Cargando métodos de pago...</p>
							</div>
						</div>
					</div>

					<div class="d-grid mt-4">
						<button id="pay-button" class="btn btn-lg btn-success" onclick="processPayment()" disabled>Pagar</button>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- Placeholder para el footer reutilizable -->
    <div id="footer-placeholder"></div>

	<script src="js/header.js"></script>
	<script src="js/footer.js"></script>
	<script src="js/burguer-button.js"></script>
	<script src="js/logout.js"></script>
	<script src="js/api.js"></script>
	<script>
		const accessToken = localStorage.getItem('accessToken');

		document.addEventListener('DOMContentLoaded', function () {
			if (!accessToken) {
				window.location.href = 'login.html'; // Redirigir si no está logueado
			} else {
				// initApp() se llama desde header.js
				fetchCartDetailsForOrder(); // Renombramos para claridad
				fetchAddresses();
				fetchPaymentMethods();
			}
		});

		async function fetchApi(url, options = {}) {
			const defaultOptions = {
				headers: {
					'Content-Type': 'application/json',
					'Authorization': 'Bearer ' + accessToken
				}
			};
			const response = await fetch(url, { ...defaultOptions, ...options });
			if (!response.ok) {
				const errorData = await response.json().catch(() => ({ detail: 'Error desconocido' }));
				throw new Error(errorData.detail);
			}
			if (response.status === 204) return null;
			return response.json();
		}

		async function fetchCartDetailsForOrder() {
			try { // La función fetchApi ya usa la URL absoluta, pero lo hacemos explícito para claridad
				const cartDetails = await fetchApi(`${API_BASE_URL}/carrito/mi_carrito/detalles`);
				renderOrderSummary(cartDetails);
			} catch (error) {
				document.getElementById('order-summary-container').innerHTML = `<p class="text-danger">${error.message}</p>`;
			}
		}

		function renderOrderSummary(cartDetails) {
			const summaryContainer = document.getElementById('order-summary-container');
			const totalContainer = document.getElementById('order-total-container');
			summaryContainer.innerHTML = '';
			let total = 0;

			if (!cartDetails || cartDetails.length === 0) {
				summaryContainer.innerHTML = '<p class="text-muted">Tu carrito está vacío. Vuelve al inicio para añadir productos.</p>';
				document.getElementById('pay-button').disabled = true;
				return;
			}

			cartDetails.forEach(item => {
				summaryContainer.innerHTML += `
					<div class="d-flex justify-content-between align-items-center mb-2">
						<div>
							<p class="mb-0">${item.product_name} <small class="text-muted">x ${item.quantity}</small></p>
						</div>
						<span>$${(item.price * item.quantity).toFixed(2)}</span>
					</div>`;
				total += item.price * item.quantity;
			});

			totalContainer.innerHTML = `<h4 class="fw-bold">Total: $${total.toFixed(2)}</h4>`;
		}

		async function fetchAddresses() {
			try {
				// NOTA: Debes crear este endpoint en tu backend.
				const addresses = await fetchApi(`${API_BASE_URL}/usuarios/me/direcciones`);
				renderAddresses(addresses);
			} catch (error) {
				document.getElementById('address-container').innerHTML = `<p class="text-danger">No se pudieron cargar las direcciones. <a href="#" onclick="toggleNewAddressForm(true)">Añadir una nueva</a></p>`;
			}
		}

		function renderAddresses(addresses) {
			const container = document.getElementById('address-container');
			container.innerHTML = '';
			if (addresses.length > 0) {
				addresses.forEach(addr => {
					container.innerHTML += `
						<div class="form-check">
							<input class="form-check-input" type="radio" name="address" id="addr-${addr.id}" value="${addr.id}" onchange="checkFormValidity()">
							<label class="form-check-label" for="addr-${addr.id}">
								${addr.address}, ${addr.city}, ${addr.zip_code}
							</label>
						</div>`;
				});
			}
			container.innerHTML += `<a href="#" class="d-block mt-2" onclick="toggleNewAddressForm(true)">+ Añadir nueva dirección</a>`;
			checkFormValidity();
		}

		function toggleNewAddressForm(show) {
			document.getElementById('new-address-form').style.display = show ? 'block' : 'none';
		}

		async function saveNewAddress() {
			const address = document.getElementById('new-address-street').value;
			const city = document.getElementById('new-address-city').value;
			const zip_code = document.getElementById('new-address-zip').value;

			if (!address || !city || !zip_code) {
				alert('Por favor, completa todos los campos de la dirección.');
				return;
			}

			try {
				// NOTA: Debes crear este endpoint en tu backend.
				await fetchApi(`${API_BASE_URL}/usuarios/me/direcciones`, {
					method: 'POST',
					body: JSON.stringify({ address, city, zip_code })
				});
				toggleNewAddressForm(false);
				fetchAddresses(); // Recargar la lista de direcciones
			} catch (error) {
				alert('Error al guardar la dirección: ' + error.message);
			}
		}

		async function fetchPaymentMethods() {
			try {
				// NOTA: Debes crear este endpoint en tu backend.
				const methods = await fetchApi(`${API_BASE_URL}/metodos_pago/`);
				renderPaymentMethods(methods);
			} catch (error) {
				document.getElementById('payment-method-container').innerHTML = `<p class="text-danger">No se pudieron cargar los métodos de pago.</p>`;
			}
		}

		function renderPaymentMethods(methods) {
			const container = document.getElementById('payment-method-container');
			container.innerHTML = '';
			methods.forEach(method => {
				container.innerHTML += `
					<div class="form-check">
						<input class="form-check-input" type="radio" name="payment" id="payment-${method.id}" value="${method.id}" onchange="checkFormValidity()">
						<label class="form-check-label" for="payment-${method.id}">
							${method.name}
						</label>
					</div>`;
			});
			checkFormValidity();
		}

		function checkFormValidity() {
			const selectedAddress = document.querySelector('input[name="address"]:checked');
			const selectedPayment = document.querySelector('input[name="payment"]:checked');
			document.getElementById('pay-button').disabled = !(selectedAddress && selectedPayment);
		}

		async function processPayment() {
			const address_id = document.querySelector('input[name="address"]:checked').value;
			const payment_method_id = document.querySelector('input[name="payment"]:checked').value;

			document.getElementById('pay-button').disabled = true;
			document.getElementById('pay-button').innerText = 'Procesando...';

			try {
				const result = await fetchApi(`${API_BASE_URL}/carrito/mi_carrito/finalizar_compra`, {
					method: 'POST',
					body: JSON.stringify({ address_id: parseInt(address_id), payment_method_id: parseInt(payment_method_id) })
				});
				alert(`${result.message} Tu número de pedido es: ${result.order_id}`);
				window.location.href = 'index.html';
			} catch (error) {
				alert('Error al procesar el pago: ' + error.message);
				document.getElementById('pay-button').disabled = false;
				document.getElementById('pay-button').innerText = 'Pagar';
			}
		}
	</script>
</body>
</html>