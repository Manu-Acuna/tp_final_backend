<!DOCTYPE html>
<html lang="es">
<head>
	<title>E-commerce - perfil</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Outfit:400,500,600,700,800,900&amp;subset=latin" />
	<link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
	<link rel="stylesheet" href="css/styles.css">
	<link rel="icon" type="image/png" sizes="48x48" href="./favicon.png" />
</head>

<body>
	<!-- Placeholder para el header reutilizable -->
    <div id="header-placeholder"></div>

	<!-- Placeholder para el carrito reutilizable -->
    <div id="cart-placeholder"></div>

	<main class="container py-5">
		<div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold mb-0">Mi Cuenta</h1>
        </div>
		<div class="row">
			<!-- Columna de Navegación -->
			<div class="col-lg-3">
				<div class="nav flex-column nav-pills me-lg-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
					<button class="nav-link active text-start d-flex align-items-center gap-2" id="v-pills-profile-tab" data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab" aria-controls="v-pills-profile" aria-selected="true">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/></svg>
						Mi Perfil
					</button>
					<button class="nav-link text-start d-flex align-items-center gap-2" id="v-pills-orders-tab" data-bs-toggle="pill" data-bs-target="#v-pills-orders" type="button" role="tab" aria-controls="v-pills-orders" aria-selected="false">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-box-seam-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15.528 2.973a.75.75 0 0 1 .472.696v8.662a.75.75 0 0 1-.472.696l-7.25 2.9a.75.75 0 0 1-.557 0l-7.25-2.9A.75.75 0 0 1 0 12.331V3.669a.75.75 0 0 1 .471-.696L7.723.023a.75.75 0 0 1 .557 0zM10.404 2 4.25 4.461 1.846 3.5 1 3.839v.4l6.5 2.6v7.922l.5.2.5-.2V6.84l6.5-2.6v-.4l-.846-.339L10.404 2z"/></svg>
						Mis Pedidos
					</button>
					<button class="nav-link text-start d-flex align-items-center gap-2 mt-2" onclick="logout()">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg>
						Cerrar Sesión
					</button>
				</div>
			</div>

			<!-- Columna de Contenido -->
			<div class="col-lg-9">
				<div class="tab-content" id="v-pills-tabContent">
					<!-- Contenido de Mi Perfil -->
					<div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
						<div class="card shadow-sm">
							<div class="card-header bg-light p-3">
								<h4 class="mb-0">Información Personal</h4>
							</div>
							<div class="card-body p-4" id="profile-content">
								<p class="text-muted">Cargando información del perfil...</p>
							</div>
						</div>
					</div>
					<!-- Contenido de Mis Pedidos -->
					<div class="tab-pane fade" id="v-pills-orders" role="tabpanel" aria-labelledby="v-pills-orders-tab">
						<div class="card shadow-sm">
							<div class="card-header bg-light p-3">
								<h4 class="mb-0">Historial de Pedidos</h4>
							</div>
							<div class="card-body p-4" id="orders-content">
								<p class="text-muted">Cargando historial de pedidos...</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>

	<!-- Placeholder para el footer reutilizable -->
    <div id="footer-placeholder"></div>

	<script src="js/api.js"></script>
	<script src="js/logout.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const accessToken = localStorage.getItem('accessToken');
			if (!accessToken) {
				window.location.href = 'login.html';
				return;
			}
			// initApp() se llama desde header.js, que a su vez llama a updateNavbar, etc.
            loadUser();
			loadOrders();

			// Permite activar una pestaña desde la URL (ej. perfil.html#v-pills-orders)
			const hash = window.location.hash;
			if (hash) {
				const triggerEl = document.querySelector(`button[data-bs-target="${hash}"]`);
				if (triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show();
			}
		});

		// Función unificada para hacer llamadas a la API con autenticación
		async function fetchApi(url, options = {}) {
			const accessToken = localStorage.getItem('accessToken');
			const defaultOptions = {
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${accessToken}`
				}
			};
			
			const response = await fetch(`${API_BASE_URL}${url}`, { ...defaultOptions, ...options });

			if (response.status === 401) {
				// Token inválido o expirado, desloguear al usuario.
				logout();
				return; // Detener la ejecución
			}

			if (!response.ok) {
				const errorData = await response.json().catch(() => ({ detail: 'Error desconocido' }));
				throw new Error(errorData.detail);
			}
			
			return response.status === 204 ? null : response.json();
		}

		// Carga y muestra la información del usuario
		async function loadUser() {
			const profileContent = document.getElementById('profile-content');
			try {
				const user = await fetchApi('/users/me/');
				profileContent.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1" id="user-info-container">
                            <h5 class="fw-bold" data-nombre="${user.nombre}" data-apellido="${user.apellido}">${user.nombre} ${user.apellido}</h5>
                            <p class="text-muted mb-1">${user.email}</p>
                        </div>
                        <div class="ms-auto" id="user-actions-container">
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleEditMode(true)">Editar Perfil</button>
                        </div>
                    </div>
                `;
			} catch (error) {
				console.error('Error al cargar el perfil:', error);
				profileContent.innerHTML = `<p class="text-danger">Error al cargar el perfil: ${error.message}</p>`;
			}
		}

		// Cambia entre el modo de vista y el modo de edición del perfil
		function toggleEditMode(isEditing) {
			const infoContainer = document.getElementById('user-info-container');
			const actionsContainer = document.getElementById('user-actions-container');
			const nameElement = infoContainer.querySelector('h5');

			if (isEditing) {
				const nombre = nameElement.getAttribute('data-nombre');
				const apellido = nameElement.getAttribute('data-apellido');

				infoContainer.innerHTML = `
					<div class="row g-2">
						<div class="col-md-6">
							<input type="text" id="edit-nombre" class="form-control" value="${nombre}" placeholder="Nombre">
						</div>
						<div class="col-md-6">
							<input type="text" id="edit-apellido" class="form-control" value="${apellido}" placeholder="Apellido">
						</div>
					</div>
					<p class="text-muted mb-1">${infoContainer.querySelector('p').innerText}</p>
				`;
				actionsContainer.innerHTML = `
					<button class="btn btn-sm btn-success" onclick="saveProfile()">Guardar</button>
					<button class="btn btn-sm btn-secondary ms-2" onclick="toggleEditMode(false)">Cancelar</button>
				`;
			} else {
				// Si se cancela, simplemente recargamos la información original
				loadUser();
			}
		}

		// Guarda los cambios del perfil
		async function saveProfile() {
			const nombre = document.getElementById('edit-nombre').value;
			const apellido = document.getElementById('edit-apellido').value;

			try {
				await fetchApi('/users/me/', {
					method: 'PUT',
					body: JSON.stringify({ nombre, apellido })
				});
				alert('Perfil actualizado con éxito.');
				toggleEditMode(false); // Volver al modo de vista
			} catch (error) {
				alert(`Error al actualizar el perfil: ${error.message}`);
			}
		}

		// Carga y muestra el historial de pedidos
		async function loadOrders() {
			const ordersContent = document.getElementById('orders-content');
			try {
				const orders = await fetchApi("/pedidos");

				if (orders && orders.length > 0) {
					const ordersList = document.createElement('div');
					ordersList.className = 'list-group';
					orders.forEach(order => {
						const orderItem = document.createElement('a');
						orderItem.href = `pedido_detalle.html?id=${order.id}`;
						orderItem.className = 'list-group-item list-group-item-action flex-column align-items-start';
						orderItem.innerHTML = `
							<div class="d-flex w-100 justify-content-between">
								<h5 class="mb-1">Pedido #${order.id}</h5>
								<small>${new Date(order.date).toLocaleDateString()}</small>
							</div>
							<p class="mb-1">Total: <strong>${formatPrice(order.total)}</strong></p>
							<small>Estado: <span class="badge bg-primary">${order.status}</span></small>
						`;
						ordersList.appendChild(orderItem);
					});
					ordersContent.appendChild(ordersList);
				} else {
					ordersContent.innerHTML = '<p>No tienes pedidos realizados aún.</p>';
				}
			} catch (error) {
				console.error("Error al obtener los pedidos:", error);
				ordersContent.innerHTML = `<p class="text-danger">Error al cargar el historial de pedidos: ${error.message}</p>`;
			}
		}
	</script>
	<!-- Scripts de componentes reutilizables -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="js/header.js"></script>
	<script src="js/cart.js"></script>
	<script src="js/footer.js"></script>
	<script src="js/burguer-button.js"></script>
</body>
</html>