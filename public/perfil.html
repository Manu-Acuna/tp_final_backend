<!DOCTYPE html>
<html lang="es">
<head>
	<title>E-commerce - perfil</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Outfit:400,500,600,700,800,900&amp;subset=latin" />
	<link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
	<link rel="stylesheet" href="css/styles.css">
	<link rel="icon" type="image/png" sizes="48x48" href="./favicon.png" />
</head>

<body>
	<!-- Placeholder para el header reutilizable -->
    <div id="header-placeholder"></div>

	<!-- Placeholder para el carrito reutilizable -->
    <div id="cart-placeholder"></div>

	<main class="container py-5">
		<div class="row">
			<!-- Columna de Navegación -->
			<div class="col-md-3">
				<div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
					<button class="nav-link active text-start" id="v-pills-profile-tab" data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab" aria-controls="v-pills-profile" aria-selected="true">Mi Perfil</button>
					<button class="nav-link text-start" id="v-pills-orders-tab" data-bs-toggle="pill" data-bs-target="#v-pills-orders" type="button" role="tab" aria-controls="v-pills-orders" aria-selected="false">Mis Pedidos</button>
					<button class="nav-link text-start" onclick="logout()">Cerrar Sesión</button>
				</div>
			</div>

			<!-- Columna de Contenido -->
			<div class="col-md-9">
				<div class="tab-content" id="v-pills-tabContent">
					<!-- Contenido de Mi Perfil -->
					<div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
						<div class="card shadow-sm">
							<div class="card-body" id="profile-content">
								<p class="text-muted">Cargando información del perfil...</p>
							</div>
						</div>
					</div>
					<!-- Contenido de Mis Pedidos -->
					<div class="tab-pane fade" id="v-pills-orders" role="tabpanel" aria-labelledby="v-pills-orders-tab">
						<div class="card shadow-sm">
							<div class="card-body" id="orders-content">
								<p class="text-muted">Cargando historial de pedidos...</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>

	<!-- Placeholder para el footer reutilizable -->
    <div id="footer-placeholder"></div>

	<script src="js/api.js"></script>
	<script src="js/logout.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const accessToken = localStorage.getItem('accessToken');
			if (!accessToken) {
				window.location.href = 'login.html';
				return;
			}
			// initApp() se llama desde header.js, que a su vez llama a updateNavbar, etc.
            loadUser();
			loadOrders();
		});

		// Función unificada para hacer llamadas a la API con autenticación
		async function fetchApi(url, options = {}) {
			const accessToken = localStorage.getItem('accessToken');
			const defaultOptions = {
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${accessToken}`
				}
			};
			
			const response = await fetch(`${API_BASE_URL}${url}`, { ...defaultOptions, ...options });

			if (response.status === 401) {
				// Token inválido o expirado, desloguear al usuario.
				logout();
				return; // Detener la ejecución
			}

			if (!response.ok) {
				const errorData = await response.json().catch(() => ({ detail: 'Error desconocido' }));
				throw new Error(errorData.detail);
			}
			
			return response.status === 204 ? null : response.json();
		}

		// Carga y muestra la información del usuario
		async function loadUser() {
			const profileContent = document.getElementById('profile-content');
			try {
				const user = await fetchApi('/users/me/');
				profileContent.innerHTML = `
					<h4 class="card-title mb-4">Información Personal</h4>
					<p><strong>Nombre:</strong> ${user.nombre} ${user.apellido}</p>
					<p><strong>Email:</strong> ${user.email}</p>
					<button class="btn btn-sm btn-outline-primary">Editar Perfil</button>
				`;
			} catch (error) {
				console.error('Error al cargar el perfil:', error);
				profileContent.innerHTML = `<p class="text-danger">Error al cargar el perfil: ${error.message}</p>`;
			}
		}

		// Carga y muestra el historial de pedidos
		async function loadOrders() {
			const ordersContent = document.getElementById('orders-content');
			try {
				const orders = await fetchApi("/pedidos");
				ordersContent.innerHTML = '<h4 class="card-title mb-4">Historial de Pedidos</h4>';

				if (orders && orders.length > 0) {
					const ordersList = document.createElement('div');
					ordersList.className = 'list-group';
					orders.forEach(order => {
						const orderItem = document.createElement('a');
						orderItem.href = `pedido_detalle.html?id=${order.id}`;
						orderItem.className = 'list-group-item list-group-item-action flex-column align-items-start';
						orderItem.innerHTML = `
							<div class="d-flex w-100 justify-content-between">
								<h5 class="mb-1">Pedido #${order.id}</h5>
								<small>${new Date(order.date).toLocaleDateString()}</small>
							</div>
							<p class="mb-1">Total: <strong>${formatPrice(order.total)}</strong></p>
							<small>Estado: ${order.status}</small>
						`;
						ordersList.appendChild(orderItem);
					});
					ordersContent.appendChild(ordersList);
				} else {
					ordersContent.innerHTML += '<p>No tienes pedidos realizados aún.</p>';
				}
			} catch (error) {
				console.error("Error al obtener los pedidos:", error);
				ordersContent.innerHTML = `<p class="text-danger">Error al cargar los pedidos: ${error.message}</p>`;
			}
		}
	</script>
	<!-- Scripts de componentes reutilizables -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="js/header.js"></script>
	<script src="js/cart.js"></script>
	<script src="js/footer.js"></script>
	<script src="js/burguer-button.js"></script>
</body>
</html>